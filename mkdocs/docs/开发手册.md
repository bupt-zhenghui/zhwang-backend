# 开发手册

## ElasticSearch部署

- **下载docker镜像**

```shell
docker pull elasticsearch:8.10.4
```

- **将以下配置文件替换原本配置**

```shell
# es.conf

cluster.name: "docker-cluster"
network.host: 0.0.0.0
http.port: 9200 # 端口号
 
# bootstrap.memory_lock: false
 
#----------------------- BEGIN SECURITY AUTO CONFIGURATION -----------------------
#
# The following settings, TLS certificates, and keys have been automatically
# generated to configure Elasticsearch security features on 04-11-2023 14:41:19
#
# --------------------------------------------------------------------------------
 
# Enable security features
# 开启登陆验证
# xpack.serurity.enbaled : true 必须加上否则启动报错
xpack.security.enabled: true
 
xpack.security.enrollment.enabled: true
 
# 允许跨域请求
http.cors.enabled: true
http.cors.allow-origin: "*"
 
# RaDKza2uS2kQiI3weSun
# Enable encryption for HTTP API client connections, such as Kibana, Logstash, and Agents
# xpack.security.http.ssl: 
  # enabled: true
    # keystore.path: certs/http.p12
 
    #Enable encryption and mutual authentication between cluster nodes
    # xpack.security.transport.ssl: 
      # enabled: true
        # verification_mode: certificate
          # keystore.path: certs/transport.p12
            # truststore.path: certs/transport.p12
# ----------------------- END SECURITY AUTO CONFIGURATION -------------------------
```

- **创建并启动容器**

```shell
docker run -d -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node"  -e JVM_OPTS="-Xms512m -Xmx1g" -v /Users/zhenghui/bin/conf/elasticsearch/es.conf:/usr/share/elasticsearch/config/elasticsearch.yml --name els elasticsearch:8.10.4 
```

- **修改密码**

```shell
docker exec -it els /bin/bash
# 手动修改密码（将所有密码修改为与用户名相同）
/usr/share/elasticsearch/bin/elasticsearch-setup-passwords interactive

# curl修改密码
/usr/share/elasticsearch/bin/elasticsearch-reset-password -u kibana
# kibana: f+P272D-SAXt0dqmoywg
```

- **访问9200端口，返回正常**

```shell
# http://localhost:9200

{
"name": "5e51aac2a4cc",
"cluster_name": "docker-cluster",
"cluster_uuid": "w_SAY91oSgCm-k0Rv1pU7Q",
"version": {
"number": "8.10.4",
"build_flavor": "default",
"build_type": "docker",
"build_hash": "b4a62ac808e886ff032700c391f45f1408b2538c",
"build_date": "2023-10-11T22:04:35.506990650Z",
"build_snapshot": false,
"lucene_version": "9.7.0",
"minimum_wire_compatibility_version": "7.17.0",
"minimum_index_compatibility_version": "7.0.0"
},
"tagline": "You Know, for Search"
}
```



## Kibana部署

- **下载kibana镜像**

```shell
docker pull kibana:8.10.4
```

- **创建kibana配置文件**

```shell
#
## ** THIS IS AN AUTO-GENERATED FILE **
##
#
## Default Kibana configuration for docker target
server.host: "0.0.0.0"
server.shutdownTimeout: "5s"
elasticsearch.hosts: [ "http://10.29.196.83:9200" ]
 
elasticsearch.username: kibana
elasticsearch.password: f+P272D-SAXt0dqmoywg
```

- **<font color=red>注意</font>：hosts中的ip，需要用`ifconfig`查询出来动态的本地ip**
- **启动kibana镜像**

```shell
docker run -d -p 5601:5601 -v /Users/zhenghui/bin/conf/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml --name kibana kibana:8.10.4
```

- **访问5601端口，使用超级用户登录**



## Logstash部署

- **下载logstash镜像**

```shell
docker pull docker.elastic.co/logstash/logstash:8.10.4
```

- **创建logstash系统配置文件**

```yaml
# logstash.yml
http.host: "0.0.0.0"
xpack.monitoring.enabled: true
xpack.monitoring.elasticsearch.hosts: "http://192.168.64.1:9200"
xpack.monitoring.elasticsearch.username: "elastic"  #es xpack账号
xpack.monitoring.elasticsearch.password: "elastic"     #es xpack账号
path.config: /usr/share/logstash/config/conf.d/*.conf
path.logs: /usr/share/logstash/logs
```

- **创建logstash pipeline配置文件**

```shell
# log_to_es.conf

input {
  file {
    path => "/usr/share/logstash/logs/*.log"
    start_position => "beginning"
     sincedb_path => "/dev/null"
    exclude => "*.gz"
  }
}

output {
  elasticsearch {
    hosts => ["http://192.168.64.1:9200"]
    index => "logs_index"
    user => elastic
    password => elastic
  }
}
```

- **创建一个测试log日志**

```shell
# test.log
hello world
```

- **启动logstash容器**

```shell
docker run -d -p 9600:9600 -v /Users/zhenghui/bin/conf/logstash/logstash.yml:/usr/share/logstash/config/logstash.yml -v /Users/zhenghui/bin/conf/logstash/log_to_es.conf:/usr/share/logstash/config/conf.d/log_to_es.conf -v /Users/zhenghui/bin/conf/logstash/logs/:/usr/share/logstash/logs/ --name logstash 814
```

- **部署成功后在kibana检索日志**

![image-20231227165544958](https://img-1300769438.cos.ap-beijing.myqcloud.com/images/202312271655265.png)




